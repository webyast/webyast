require "polkit1/version"
require 'polkit1.so' # native
require 'etc'

module PolKit1
  POLKIT_PATH = "/etc/polkit-1/rules.d/"
  # defaults are "50-default-webyast-*", use something lower to override the defaults
  FILE_PREFIX = "40-webyast-"

  def self.polkit1_check(perm, user_name)
    raise "invalid user name" if (user_name =~ /\\$/ or user_name.include? "'")
    polkit1_check_uid perm, Etc.getpwnam(user_name).uid
  end

  def self.polkit1_write(section, perm, granted, user_name)
    raise "User name required" if user_name.nil? || user_name.empty?
    raise "Invalid user name" if (user_name =~ /\\$/ or user_name.include? "'")
    raise "Action name required" if perm.nil? || perm.empty?

    # TODO: is section (subdir) supported by new polkit??
    file = File.join(POLKIT_PATH, "#{FILE_PREFIX}-#{user_name}-#{perm}.rules")

    if granted
      content = "
//
// This polkit authorization rule was created by WebYast
//
// !! WARNING: DO NOT EDIT THIS FILE !!
//
//

polkit.addRule(function(action, subject) {
  if (action.id == \"#{perm}\" &&
    subject.user == \"#{user_name}\")
  {
    return polkit.Result.YES;
  }
});
"
      File.open(file, "w") do |f|
        f.puts content
      end
    else
      File.delete(file) if File.exist?(file)
    end
  end

end

